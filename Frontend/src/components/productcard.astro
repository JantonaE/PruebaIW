---
// @ts-ignore
import { acortarTexto, compararFechas } from "@lib/utils.ts";
import CldImage from "./CldImage.astro";

// Destructure props from Astro
const { titulo, descripcion, precio, fecha_cierre, imagenes, idproducto, pagado } =
  Astro.props;

// Generate URLs based on the product ID
const productURL = `http://localhost:4321/producto/${idproducto}`;
const url = `http://127.0.0.1:8000/Puja/?producto=${idproducto}`;

// Fetch data from the provided URL
const res = await fetch(url, {
  method: "GET",
  headers: {
    "Content-Type": "application/json",
  },
});

// Parse the response as JSON
const pujas = await res.json();
let max_price = precio;
//console.log(url);
// Check if there are bids (pujas)
if (pujas.length > 0) {
  let puja;

  // Iterate through each bid
  for (let i in pujas) {
    puja = pujas[i];
    //console.log(puja);

    // Update max_price if a bid has a higher amount
    if (puja["cantidad"] > max_price) {
      max_price = puja["cantidad"];
    }
  }
}

// Get the current date and the closing date of the auction
const now = new Date();
var partesFecha = fecha_cierre.split("/");

// Las partes de la fecha están en el formato [mes, día, año]
var dia = parseInt(partesFecha[0], 10) +1; 
var mes = parseInt(partesFecha[1], 10) -1;
var año = parseInt(partesFecha[2], 10);

// Creamos un objeto Date utilizando las partes de la fecha
var closeDate = new Date(año, mes, dia);

closeDate.setDate(closeDate.getDate() - 1);

// Compare dates to determine the auction state
const estado = compararFechas(now, closeDate);
---

<div
  class="w-full md:w-1/2 lg:w-1/3 m-3 mx-10 max-w-sm bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
  <CldImage
    idproducto={idproducto}
    imagenes={imagenes}
  />
  <div class="p-5 flex flex-col justify-between">
    <div>
      <h5
        class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
        {titulo}
      </h5>
      <div class="mt-auto">
        <p class="mb-3 font-normal text-gray-700 dark:text-gray-400 h-40">
          {acortarTexto(descripcion, 100)}
        </p>
        <div class={"text-end mb-3 font-bold text-white dark:text-white"}>
          <span class={`rounded-md p-1 ${estado === 'Abierto' ? "bg-green-400 text-green-900" : (pagado ? "bg-violet-400 text-violet-900" : "bg-red-400 text-red-900")}`}>
            {pagado ? "Pagado" : estado}
          </span>
          
        </div>
        <div class="text-end mb-3 font-semibold text-black dark:text-white">
          Fecha cierre: {fecha_cierre}
        </div>
        <p class="text-end mb-3 font-bold text-xl text-black dark:text-white">
          {max_price} €
        </p>
        <a
          href={productURL}
          class="flex items-center justify-center px-3 py-2 text-sm font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
          Ver Producto
          <svg
            class="rtl:rotate-180 w-3.5 h-3.5 ms-2"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 14 10">
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M1 5h12m0 0L9 1m4 4L9 9"></path>
          </svg>
        </a>
      </div>
    </div>
  </div>
</div>
